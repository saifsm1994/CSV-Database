<!DOCTYPE html>
<html lang="en">

<head>
  <title>Lookup DB</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <link rel="stylesheet" type="text/css" href="http://w2ui.com/src/w2ui-1.4.min.css" />
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script type="text/javascript" src="http://w2ui.com/src/w2ui-1.4.min.js"></script>
</head>

<body id="body">

    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="/Static/">Home</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
    
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav mr-auto">
            <li class="nav-item">
              <a class="nav-link" href="/Static/Lookup" style="color:  black; font-weight: 500;;">Lookup </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/Static/Search" style="color:  darkslategray; font-weight: 500;">Search</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/Static/Upload" style="color:green;">Upload DB</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" style="color:red" href="/Static/Delete">Delete DB</a>
            </li>
          </ul>
        </div>
      </nav>

  <div class="jumbotron text-center" style="padding-top: 5px; padding-bottom: 5px;">
    <h1>Search Page</h1>
    <p>Choose a category to search and a word or phrase to search for.</p>
  </div>

  <div class="container" style=" margin-bottom: 100px;">
      <div class="row">

      <div class="col-sm-12 col-xs-12 card"
        style="background-color: transparent; border: transparent; padding-bottom: 12px ">
        <div class="row">
          <div class="col-sm-12 col-xs-12 card" style="background-color: whitesmoke; padding-bottom: 12px ">
            <div class="form-group">
              <label for="exampleFormControlSelect1">Database select</label>
              <select class="form-control" id="databaseSelect" onclick="saveChoice()" onchange="populateDropdowns()">
              </select>
            </div>
            <h3>Search</h3>
            <div class="row" style="margin-top: 10px;">
              <div class="col-sm-3 col-xs-12">
                <select class="form-control" id="categorySelect1"></select>
              </div>
              <div class="col-sm-9 col-xs-12 ">

                <input class="form-control form-control-md" type="text" placeholder="Search Term 1, Search Term 2..."
                  id="searchInput1">
              </div>
            </div>

            <div class="row" style="margin-top: 10px;">
              <div class="col-sm-3 col-xs-12 ">
                <select class="form-control" id="categorySelect2"></select>
              </div>
              <div class="col-sm-9 col-xs-12 ">

                <input class="form-control form-control-md" type="text" placeholder="Search Term 1, Search Term 2..."
                  id="searchInput2">
              </div>
            </div>

            <div class="row" style="margin-top: 10px;">
              <div class="col-sm-3 col-xs-12 ">
                <select class="form-control" id="categorySelect3"></select>
              </div>
              <div class="col-sm-9 col-xs-12 ">

                <input class="form-control form-control-md" type="text" placeholder="Search Term 1, Search Term 2..."
                  id="searchInput3">
              </div>
            </div>

            <div class="row" style="margin-top: 10px;">
              <div class="col-sm-3 col-xs-12 ">
                <select class="form-control" id="categorySelect4"></select>
              </div>
              <div class="col-sm-9 col-xs-12 ">

                <input class="form-control form-control-md" type="text" placeholder="Search Term 1, Search Term 2..."
                  id="searchInput4">
              </div>
            </div>


            <div class="row" style="margin-top: 10px;">
              <div class="col-sm-3 col-xs-12 ">
                <select class="form-control" id="categorySelect5"></select>
              </div>
              <div class="col-sm-9 col-xs-12 ">

                <input class="form-control form-control-md" type="text" placeholder="Search Term 1, Search Term 2..."
                  id="searchInput5">
              </div>
            </div>

            <br>

            <div class="row" style="margin-top: 10px;">
              <div class="col-sm-6 col-xs-12 ">
                <label for="mustHave">Must posess (Case insensitive)</label>
                <input class="form-control form-control-md" type="text"
                  placeholder="Must Posess Phrase 1, Must Posess Phrase 2..." id="mustInclude">
              </div>
              <div class="col-sm-6 col-xs-12 ">
                <label for="mustExclude">Must exclude (Case insensitive)</label>
                <input class="form-control form-control-md" type="text"
                  placeholder="Must Exclude Phrase 1, Must Exclude Phrase 2..." id="mustExclude">
              </div>
            </div>

            <br>


            <div class="form-check ">
              <div class="row" style="margin-top: 10px; margin-bottom: 10px;">
                <div class="col-md-3 col-sm-3 col-xs-3">
                  <input type="checkbox" class="form-check-input" id="mergeDuplicatesCheckbox" checked>
                  <label class="form-check-label" for="mergeDuplicatesCheckbox">Merge Duplicates</label>
                </div>
                <div class="col-md-3 col-sm-3 col-xs-3">
                    <input type="checkbox" class="form-check-input" id="searchTypeCheckbox" checked>
                    <label class="form-check-label" for="searchTypeCheckbox">Exact Search</label>
                  </div>
                  <div class="col-md-3 col-sm-3 col-xs-3">
                      <input type="checkbox" class="form-check-input" id="caseSensitive" checked>
                      <label class="form-check-label" for="caseSensitive">Case Insensitive</label>
                    </div>
                <div class="col-md-3 col-sm-3 col-xs-3">
                    Entries per page
                    <select class="form-control-sm" id="pagination">
                        <option>25</option>
                        <option>50</option>
                        <option>100</option>
                        <option selected>500</option>
                        <option>1000</option>
                        <option>3000</option>
                      </select>
                  </div>
              </div>
            </div>


            


            <button class="btn btn-primary" type="button" onclick="getSearch(1)">Search</button>

          </div>
        </div>
      </div>

      <div class=" offset-xl-8 offset-md-8 offset-sm-8 col-xl-4 col-md-4 col-sm-4 col-xs-12 " style="margin-top: 1%">
          <!-- <h5>Pages</h3> -->
          <!-- <div id="pageButtonsHere" class="row"></div> -->
          <nav aria-label="Page navigation example">
              <ul class="pagination" id="pageButtonsHere">

              </ul>
            </nav>
        </div>

      <div class="col-xl-12 col-md-12 col-sm-12 col-xs-12 card" style="margin-top: 1%">
          <h3>Results</h3>
          <div id="buttonsHere" class="row"></div>
          <br>
          <div id="grid" style="min-height: 450px; "></div>
        </div>

    </div>
  </div>
  </div>

  <script>

    function saveChoice() {
      let choice = document.getElementById("databaseSelect").value
      localStorage.setItem('choice', choice);
      // console.log('choice made', choice)

    }

    function fetchChoice() {
      const choice = localStorage.getItem('choice');
      if (choice) {
        document.getElementById("databaseSelect").value = choice;
        // console.log('choice found', choice)

      }
    }

    function populateDropdowns() {
      let basicInfoParsed = JSON.parse(basicInfoUnprocessed)
      document.getElementById("categorySelect1").innerHTML = "";
      document.getElementById("categorySelect2").innerHTML = "";
      document.getElementById("categorySelect3").innerHTML = "";
      document.getElementById("categorySelect4").innerHTML = "";
      document.getElementById("categorySelect5").innerHTML = "";

      let choice = document.getElementById("databaseSelect").value
      console.log(basicInfoParsed, typeof basicInfoParsed)
      let headers = basicInfoParsed[choice]["databaseHeaders"];
      let headerKeys = Object.keys(headers);
      headerKeys.forEach(element => {
        let option = "<option>" + basicInfoParsed[choice]["databaseHeaders"][element] + "</option>"
        document.getElementById("categorySelect1").innerHTML += option;
        document.getElementById("categorySelect2").innerHTML += option;
        document.getElementById("categorySelect3").innerHTML += option;
        document.getElementById("categorySelect4").innerHTML += option;
        document.getElementById("categorySelect5").innerHTML += option;
      });

    }


    let basicInfoUnprocessed = httpGet("http://localhost:3000/getAllParams");
    let basicInfo = sendData(basicInfoUnprocessed);

    function sendData(obj) { // sends database selection choices
      const listItemStart = '<option class="list-group-item value="';
      const listItemEnd = '</option>';

      obj = JSON.parse(obj)
      console.log(obj)
      console.log(obj.basicInfo.databases)

      if (obj != undefined && obj.basicInfo != undefined & obj.basicInfo.databases != undefined) {
        let databases = obj.basicInfo.databases;
        databases.forEach(element => {
          let count = obj[element].databaseSize;
          let item = listItemStart + element + '" id=' + element + '>' + element + listItemEnd;
          document.getElementById("databaseSelect").innerHTML += item
          console.log(item)
        });

        fetchChoice()
        populateDropdowns(obj)

      } else {
        console.log(obj)
        console.log(obj.basicInfo)
        console.log(obj.basicInfo.databases)

      }
    }

    function httpGet(theUrl) { // parses get request of input theUrl
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.open("GET", theUrl, false); // false for synchronous request
      xmlHttp.send(null);
      return xmlHttp.responseText;
    }

    function httpPost(theUrl, value,function1) { // parses get request of input theUrl
      var xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
            function1(this.responseText)
            return true;
        }
      };
      xhr.open("POST", theUrl, true);
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.send(JSON.stringify({
        value: value
      }));
    }


    function determinePageCount(page, pagination, count) {
      let totalPages = pagination / count
      if (totalPages < 1) { return 1 }
      if (totalPages > 1) {
        let currentPage = page / count
        if (currentPage == totalPages) { return currentPage }

      }
    }

    function getSearch(page) {
      let csvSearchValue, databaseSelectValue;
      databaseSelectValue = document.getElementById("databaseSelect").value;
      const keyword = databaseSelectValue.split("-")[0];

      let database = databaseSelectValue;
      // if( !Number.isInteger(page) ){
      // page = 1
      // }
      let searchType = document.getElementById("searchTypeCheckbox").checked
      let caseSensitive = document.getElementById("caseSensitive").checked
      let orSearchCat = [];
      let orSearchCombinations = [];
      let mustInclude = document.getElementById("mustInclude").value;
      let mustExclude = document.getElementById("mustExclude").value;
      let pagination = document.getElementById("pagination").value;


      
      orSearchCat.push(document.getElementById("categorySelect1").value)
      orSearchCat.push(document.getElementById("categorySelect2").value)
      orSearchCat.push(document.getElementById("categorySelect3").value)
      orSearchCat.push(document.getElementById("categorySelect4").value)
      orSearchCat.push(document.getElementById("categorySelect5").value)

      orSearchCombinations.push(document.getElementById("searchInput1").value.split(","))
      orSearchCombinations.push(document.getElementById("searchInput2").value.split(","))
      orSearchCombinations.push(document.getElementById("searchInput3").value.split(","))
      orSearchCombinations.push(document.getElementById("searchInput4").value.split(","))
      orSearchCombinations.push(document.getElementById("searchInput5").value.split(","))

      let requestObj = {}
      requestObj["database"] = database
      requestObj["pagination"] = pagination
      requestObj["page"] = page
      requestObj["searchType"] = searchType
      requestObj["orSearchCat"] = orSearchCat
      requestObj["orSearchCombinations"] = orSearchCombinations
      requestObj["mustInclude"] = mustInclude
      requestObj["mustExclude"] = mustExclude
      requestObj["caseSensitive"] = caseSensitive

      

      // console.log("requestObj", requestObj)


      let returnGet = httpPost("http://localhost:3000/postSearch", requestObj,waitForPost)

      function waitForPost(returnGet) {
        returnGet = JSON.parse(returnGet);
        let headerKeys = returnGet["internalMessages"]["headers"]; // object headers
        let len = returnGet["internalMessages"]["len"]; // entries in the return object for pagination
        let pageCount = Math.ceil(len/pagination);
        console.log("len",len,pageCount,"pages")//getSearch(2)
        paginationButtons(pageCount)

        let returnedEntries = Object.keys(returnGet) // list of all entries
        let returnRowsParsed = []; // array for return after logic is applied


        returnedEntries.forEach(element => { // to prevent inclusion of internal messages in table
          if (element != "internalMessages") {
            returnRowsParsed.push(returnGet[element]) // full return objects are here
          }
        });

        let headers = makeHeaders(headerKeys, keyword);
        let searches = makeSearches(headerKeys, keyword);
        let sorts = makeSorts(headerKeys, keyword);
        let records = makeRecords(headerKeys, returnRowsParsed, keyword)

        if (!headers || !searches || !sorts || !records) { alert("process failed") }
        let table = makeTable(headers, searches, sorts, records)
        if (table) {
          makeGrid(table, headerKeys, keyword);
        }

        function paginationButtons(pageCount){
        document.getElementById("pageButtonsHere").innerHTML = ""
        let buttonStart = "<li class='page-item'><a class='page-link' href='#'' onclick='"
        let buttonMid = "'>"
        let buttonEnd = "</a></li>"
       

        for(let i = 1; i<= pageCount; i++){
          let button;
          
          button = buttonStart + "getSearch(\"" + i + '\")' + buttonMid + i + buttonEnd
          document.getElementById("pageButtonsHere").innerHTML += button
        }
       } 

      }

    }

    function makeHeaders(arr, keyword) {
      let header = []
      if (Array.isArray(arr)) {
        arr.forEach(element => {
          let innerHeader = {}
          if (element == keyword) {
            innerHeader["field"] = "recid";
          } else {
            innerHeader["field"] = element;
          }
          innerHeader["caption"] = element;
          innerHeader["size"] = '150px';
          innerHeader["sortable"] = true;
          innerHeader["attr"] = 'align=center';
          innerHeader["editable"] = { type: 'text' };
          header.push(innerHeader)
        });
        return header
      } else {
        return false
      }

    }

    function makeSearches(arr, keyword) {
      let searches = []
      if (Array.isArray(arr)) {
        arr.forEach(element => {
          //  { field: 'recid', caption: 'ID', type: 'text' },
          let innerSearch = {}
          if (element == keyword) {
            innerSearch["field"] = "recid";
          } else {
            innerSearch["field"] = element;
          }
          innerSearch["caption"] = element;
          innerSearch["type"] = 'text';
          searches.push(innerSearch)
        });
        return searches
      } else {
        return false
      }
    }

    function makeSorts(arr, keyword) {
      let sorts = []
      if (Array.isArray(arr)) {
        arr.forEach(element => {
          //  { field: 'recid', direction: '' },
          let innerSort = {}
          if (element == keyword) {
            innerSort["field"] = "recid";
          } else {
            innerSort["field"] = element;
          }
          innerSort["direction"] = '';
          sorts.push(innerSort)
        });
        return sorts
      } else {
        return false
      }
    }

    function makeRecords(headers, arrOfObjs, keyword) {
      let records = []
      // console.log("arrOfObjs", arrOfObjs)
      let cleanedArray = [];
      let mergeDuplicatesCheckbox = document.getElementById("mergeDuplicatesCheckbox").checked

      if (!mergeDuplicatesCheckbox) { // checkbox test - merge duplicates if checked
        if (Array.isArray(arrOfObjs)) { // if unchecked do not merge
          arrOfObjs.forEach(obj => {
            if (obj["mult"] == "multer") {
              let innerKeys = Object.keys(obj);
              innerKeys.forEach(element => {
                if (element != "mult") {
                  cleanedArray.push(obj[element])
                }
              });
            } else {
              cleanedArray.push(obj)
            }
          })
        }
      } else { // if checked merge, cannot handle <br> tags well
        arrOfObjs.forEach(obj => {
          let mergeArray = [] // array of objects we want to merge
          if (obj["mult"] == "multer") {
            let innerKeys = Object.keys(obj);
            innerKeys.forEach(element => { // push the child objects into merging array
              if (element != "mult") {
                mergeArray.push(obj[element])
                // console.log("pushing obj ", obj[element])
              }
            });

            let mergeObj = {}
            // console.log("mergeArray", mergeArray)
            mergeArray.forEach(childObj => {
              headers.forEach(header => {
                if (mergeObj[header]) {
                  if (childObj[header] && mergeObj[header] != childObj[header]) {
                    let test = mergeObj[header].split(" <br> ")
                    let result = true
                    test.forEach(element => {
                      if (element == childObj[header]) {
                        result = false
                      }
                    });
                    if (result) {
                      mergeObj[header] = mergeObj[header] + " <br> " + childObj[header]
                    }
                  }
                } else {
                  if (childObj[header]) {
                    mergeObj[header] = childObj[header]
                  }
                }
              });
            });

            cleanedArray.push(mergeObj)
            // console.log("mergeObj",mergeObj)


          } else {
            cleanedArray.push(obj)
          }
        })
      }


      if (Array.isArray(cleanedArray)) {//takes cleaned and merged array and formats  not found rows
        cleanedArray.forEach(row => {
          let innerRecord = {}

          headers.forEach(header => {
            if (row[header]) {
              if (header == keyword) {
                innerRecord["recid"] = row[header];
              } else {
                innerRecord[header] = row[header];
              }
            } else {
              if (header == keyword) {
                innerRecord["recid"] = "Not Found";
              } else {
                innerRecord[header] = "Not Found";
              }
            }
          });
          records.push(innerRecord)
        });
        return records
      } else {
        return false
      }
    }

    function makeTable(headers, searches, sorts, records) {
      let table = { // table format
        name: 'grid',
        contextMenu: function () { },
        header: 'Return Table',
        reorderColumns: true,
        show: {
          toolbar: true,
          footer: true,
          toolbarSearch: true
        },
        columns: headers,
        searches: searches,
        sortData: sorts,
        records: records
      }
      return table
    }

    function makeButtons(headers, keyword) {
      // <button class="w2ui-btn" onclick="w2ui.grid.toggleColumn('sdate');">Toggle Last Column</button>
      let buttonStart = "<button class='w2ui-btn' onclick='w2ui.grid.toggleColumn("
      let buttonMid = ")'>"
      let buttonEnd = '</button>'
      let button;

      let buttonStart2 = "<button class='w2ui-btn' onclick='w2ui.grid.hideColumn("
      let button2;


      let buttonStart3 = "<button class='w2ui-btn' onclick='w2ui.grid.showColumn("
      let button3;


      document.getElementById("buttonsHere").innerHTML = ""

      //show All
      let all = headers.map(element => "\"" + element + "\"").join(",")
      button3 = buttonStart3 + "\"recid\"," + all + buttonMid + "Show All" + buttonEnd;
      document.getElementById("buttonsHere").innerHTML += button3

      //Hide All
      button2 = buttonStart2 + "\"recid\"," + all + buttonMid + "Hide All" + buttonEnd;
      document.getElementById("buttonsHere").innerHTML += button2


      headers.forEach(element => {
        if (element == keyword) {
          button = buttonStart + "\"recid\"" + buttonMid + element + buttonEnd;
        } else {
          button = buttonStart + "\"" + element + "\"" + buttonMid + element + buttonEnd;
        }
        document.getElementById("buttonsHere").innerHTML += button
      });

    }


    function makeGrid(obj, headers, keyword) {
      if (w2ui.hasOwnProperty('grid')) { w2ui['grid'].destroy(); }
      $('#grid').w2grid(obj);
      makeButtons(headers, keyword);
    }


    // $('#grid').w2grid({ // table format
    //   name: 'grid',
    //   header: 'Return Table',
    //   show: {
    //     toolbar: true,
    //     footer: true
    //   },
    //   columns: [
    //     { field: 'recid', caption: 'ID', size: '50px', sortable: true, attr: 'align=center' },
    //     { field: 'lname', caption: 'Last Name', size: '30%', sortable: true, resizable: true },
    //     { field: 'fname', caption: 'First Name', size: '30%', sortable: true, resizable: true },
    //     { field: 'email', caption: 'Email', size: '40%', resizable: true },
    //     { field: 'sdate', caption: 'Start Date', size: '120px', resizable: true },
    //   ],
    //   searches: [
    //     { field: 'recid', caption: 'ID', type: 'text' },
    //     { field: 'lname', caption: 'Last Name', type: 'text' },
    //     { field: 'fname', caption: 'First Name', type: 'text' },
    //     { field: 'email', caption: 'Email', type: 'text' },
    //   ],
    //   sortData: [{ field: 'recid', direction: '' }],
    //   records: [
    //     { recid: 1, fname: 'John', lname: 'doe', email: 'jdoe@gmail.com', sdate: '4/3/2012' },
    //     { recid: 3, fname: 'Jin', lname: 'Franson', email: 'jdoe@gmail.com', sdate: '4/3/2012' },
    //     { recid: 2, fname: 'Stuart', lname: 'Motzart', email: 'jdoe@gmail.com', sdate: '4/3/2012' },
    //     { recid: 4, fname: 'Susan', lname: 'Ottie', email: 'jdoe@gmail.com', sdate: '4/3/2012' },
    //     { recid: 5, fname: 'Kelly', lname: 'Silver', email: 'jdoe@gmail.com', sdate: '4/3/2012' },
    //     { recid: 6, fname: 'Francis', lname: 'Gatos', email: 'jdoe@gmail.com', sdate: '4/3/2012' },
    //     { recid: 7, fname: 'Mark', lname: 'Welldo', email: 'jdoe@gmail.com', sdate: '4/3/2012' },
    //     { recid: 8, fname: 'Thomas', lname: 'Bahh', email: 'jdoe@gmail.com', sdate: '4/3/2012' },
    //     { recid: 9, fname: 'Sergei', lname: 'Rachmaninov', email: 'jdoe@gmail.com', sdate: '4/3/2012' },
    //     { recid: 20, fname: 'Jill', lname: 'Doe', email: 'jdoe@gmail.com', sdate: '4/3/2012' },
    //     { recid: 21, fname: 'Frank', lname: 'Motzart', email: 'jdoe@gmail.com', sdate: '4/3/2012' },
    //     { recid: 22, fname: 'Peter', lname: 'Franson', email: 'jdoe@gmail.com', sdate: '4/3/2012' },
    //     { recid: 23, fname: 'Andrew', lname: 'Ottie', email: 'jdoe@gmail.com', sdate: '4/3/2012' },
    //     { recid: 24, fname: 'Manny', lname: 'Silver', email: 'jdoe@gmail.com', sdate: '4/3/2012' },
    //     { recid: 25, fname: 'Ben', lname: 'Gatos', email: 'jdoe@gmail.com', sdate: '4/3/2012' },
    //     { recid: 26, fname: 'Doer', lname: 'Welldo', email: 'jdoe@gmail.com', sdate: '4/3/2012' },
    //     { recid: 27, fname: 'Shashi', lname: 'bahh', email: 'jdoe@gmail.com', sdate: '4/3/2012' },
    //     { recid: 28, fname: 'Av', lname: 'Rachmaninov', email: 'jdoe@gmail.com', sdate: '4/3/2012' }
    //   ]
    // });

  </script>

</body>

</html>